name: Build Nuitka Module for FreeBSD 14.1

# این اکشن فقط به صورت دستی از طریق تب Actions در گیت‌هاب اجرا می‌شود
on:
  workflow_dispatch:

jobs:
  build-on-freebsd:
    name: Compile Python on FreeBSD 14.1 (amd64)
    # از یک ماشین مجازی مک استفاده می‌کنیم چون اکشن شبیه‌ساز FreeBSD روی آن بهتر کار می‌کند
    runs-on: macos-13

    steps:
      # مرحله ۱: راه‌اندازی ماشین مجازی FreeBSD با مشخصات دقیق سرور شما
      - name: Setup FreeBSD VM
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          release: '14.1' # <<<< مطابق با نسخه سرور شما

      # مرحله ۲: کپی کردن کدهای پروژه شما به داخل ماشین مجازی
      - name: Checkout project code
        uses: actions/checkout@v4
        with:
          path: filmbin_project # کدها در این پوشه قرار می‌گیرند

      # مرحله ۳: نصب نیازمندی‌ها و کامپایل با Nuitka در داخل FreeBSD
      - name: Install dependencies and Compile with Nuitka
        run: |
          echo ">>> Updating package manager..."
          pkg update -f
          
          echo ">>> Installing Python 3.11 and pip..."
          # ما دقیقاً نسخه 3.11 پایتون را نصب می‌کنیم
          pkg install -y python311 py311-pip
          
          echo ">>> Installing Python packages..."
          # نیازمندی‌های پروژه را با pip مخصوص پایتون 3.11 نصب می‌کنیم
          python3.11 -m pip install fastapi uvicorn httpx jinja2 nuitka
          
          echo ">>> Changing directory to project folder..."
          cd filmbin_project
          
          echo ">>> Starting Nuitka compilation for Python 3.11..."
          # دستور کامپایل هیولا با استفاده از python3.11
          python3.11 -m nuitka --module \
            --jobs=2 \
            --nofollow-import-to=tkinter,unittest \
            --enable-plugin=anti-bloat \
            --python-flag=-OO \
            --output-dir=build \
            main.py
          echo ">>> Nuitka compilation finished successfully!"

      # مرحله ۴: آپلود کردن فایل نهایی به عنوان آرتیفکت قابل دانلود
      - name: Upload compiled module as artifact
        uses: actions/upload-artifact@v4
        with:
          # اسم فایلی که در نهایت دانلود خواهید کرد
          name: filmbin-freebsd-14.1-py3.11-amd64
          # مسیر دقیق فایل کامپایل شده در ماشین مجازی
          # نام فایل .so شامل نسخه پایتون و معماری خواهد بود
          path: filmbin_project/build/main.so 
          # فایل تا ۷ روز برای دانلود در دسترس خواهد بود
          retention-days: 7
