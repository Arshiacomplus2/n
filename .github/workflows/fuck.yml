name: Build Nuitka Module via Cross-Compilation

on:
  workflow_dispatch:

jobs:
  build:
    name: Cross-Compile for FreeBSD on Linux
    # از یک رانر سریع و در دسترس اوبونتو استفاده می‌کنیم
    runs-on: ubuntu-latest

    steps:
      # مرحله ۱: کپی کردن کدها (بدون تغییر)
      - name: Checkout project code
        uses: actions/checkout@v4

      # مرحله ۲: نصب ابزارهای لازم برای کامپایل متقاطع
      - name: Install Cross-Compilation Tools
        run: |
          sudo apt-get update
          # نصب کامپایلر C و ابزارهای لازم برای FreeBSD
          sudo apt-get install -y clang lld
          
      # مرحله ۳: نصب Nuitka و نیازمندی‌های پایتون
      - name: Set up Python and Install Dependencies
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # مطابق با نسخه سرور شما
      - run: python -m pip install --upgrade pip nuitka fastapi uvicorn httpx jinja2

      # مرحله ۴: اجرای Nuitka با تنظیمات کامپایل متقاطع
      - name: Run Nuitka Cross-Compilation
        run: |
          python -m nuitka --module \
            --jobs=$(nproc) \
            --nofollow-import-to=tkinter,unittest \
            --enable-plugin=anti-bloat \
            --python-flag=-OO \
            --output-dir=build \
            --target=freebsd \
            --clang-version=14 \
            main.py
      
      # مرحله ۵: آپلود آرتیفکت نهایی (بدون تغییر)
      - name: Upload compiled module as artifact
        uses: actions/upload-artifact@v4
        with:
          name: filmbin-freebsd-14.1-py3.11-amd64
          path: build/main.so
          retention-days: 7
